<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detecção e Captura</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        video, canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 10px;
        }

        #controls {
            position: absolute;
            top: 20px;
            display: flex;
            gap: 10px;
            z-index: 1;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        #captureBtn {
            margin-top: 20px;
            background-color: #28a745;
        }

        #photoContainer {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        #capturedImage {
            width: 320px;
            height: 240px;
            border: 2px solid #ddd;
        }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline width="640" height="480"></video>
    <canvas id="captureFrame" width="640" height="480"></canvas>
    <div id="controls">
        <button id="btnFrente">Frente</button>
        <button id="btnVerso">Verso</button>
        <button id="btnSelfie">Selfie</button>
    </div>
    <button id="captureBtn">Capturar Foto</button>
    <div id="photoContainer">
        <h3>Foto Capturada</h3>
        <img id="capturedImage" alt="Foto capturada" />
        <button id="sendBtn">Enviar Foto</button>
    </div>

    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script>
        const video = document.getElementById('video');
        const captureCanvas = document.getElementById('captureFrame');
        const ctx = captureCanvas.getContext('2d');
        const btnFrente = document.getElementById('btnFrente');
        const btnVerso = document.getElementById('btnVerso');
        const btnSelfie = document.getElementById('btnSelfie');
        const captureBtn = document.getElementById('captureBtn');
        const photoContainer = document.getElementById('photoContainer');
        const capturedImage = document.getElementById('capturedImage');
        const sendBtn = document.getElementById('sendBtn');
        const FRAME_RECT = { x: 160, y: 120, width: 320, height: 240 }; // Enquadramento
        let stream;
        let facingMode = "environment"; // Define a câmera padrão como traseira
        let capturing = false;

        // Configurar a câmera com base na direção
        async function startCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode }
                });
                video.srcObject = stream;
            } catch (error) {
                console.error("Erro ao acessar câmera:", error);
            }
        }

        // Alterar o modo de câmera (frente/traseira)
        function switchCamera(mode) {
            facingMode = mode;
            startCamera();
        }

        // Função para capturar a imagem
        function captureImage() {
            if (!capturing) {
                capturing = true;
                // Desenhar o frame no canvas
                ctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                const imageData = captureCanvas.toDataURL('image/png');
                capturedImage.src = imageData;
                photoContainer.style.display = 'block';
            }
        }

        // Função para enviar a foto (exemplo de ação)
        function sendPhoto() {
            const image = capturedImage.src;
            console.log("Enviando a foto...");

            // Exemplo de envio de imagem via POST (ajuste para o seu backend)
            // fetch('seu_servidor', {
            //     method: 'POST',
            //     body: JSON.stringify({ image: image }),
            //     headers: { 'Content-Type': 'application/json' }
            // })
            // .then(response => response.json())
            // .then(data => {
            //     console.log('Foto enviada:', data);
            // })
            // .catch(error => console.error('Erro ao enviar a foto:', error));
        }

        // Função para processar frame e detectar objeto
        function detectObject() {
            const src = cv.imread(video);
            const gray = new cv.Mat();
            const blurred = new cv.Mat();
            const edges = new cv.Mat();
            const contours = new cv.MatVector();
            const hierarchy = new cv.Mat();

            // Converter para escala de cinza
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Aplicar blur para suavizar ruídos
            cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);

            // Detectar bordas
            cv.Canny(blurred, edges, 75, 200);

            // Detectar contornos
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            // Verificar contornos
            let detected = false;
            for (let i = 0; i < contours.size(); ++i) {
                const contour = contours.get(i);
                const rect = cv.boundingRect(contour);
                const aspectRatio = rect.width / rect.height;

                // Proporção típica de uma carteira de identidade (ajustável)
                if (aspectRatio > 1.5 && aspectRatio < 1.8 &&
                    rect.width > 100 && rect.height > 50) { // Dimensão mínima aceitável
                    // Verificar se está no enquadramento
                    if (rect.x >= FRAME_RECT.x && rect.y >= FRAME_RECT.y &&
                        rect.x + rect.width <= FRAME_RECT.x + FRAME_RECT.width &&
                        rect.y + rect.height <= FRAME_RECT.y + FRAME_RECT.height) {
                        detected = true;
                        ctx.strokeStyle = 'green';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
                        break;
                    }
                }
            }

            // Desenhar enquadramento
            ctx.clearRect(0, 0, captureCanvas.width, captureCanvas.height);
            ctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            ctx.strokeStyle = detected ? 'green' : 'red';
            ctx.lineWidth = 4;
            ctx.strokeRect(FRAME_RECT.x, FRAME_RECT.y, FRAME_RECT.width, FRAME_RECT.height);

            // Liberação de memória
            src.delete();
            gray.delete();
            blurred.delete();
            edges.delete();
            contours.delete();
            hierarchy.delete();
        }

        // Atualizar o quadro regularmente
        function processFrame() {
            detectObject();
            requestAnimationFrame(processFrame);
        }

        // Iniciar câmera automaticamente e definir eventos para botões
        startCamera().then(() => processFrame());
        btnFrente.addEventListener('click', () => switchCamera("environment"));
        btnVerso.addEventListener('click', () => switchCamera("environment"));
        btnSelfie.addEventListener('click', () => switchCamera("user"));
        captureBtn.addEventListener('click', captureImage);
        sendBtn.addEventListener('click', sendPhoto);
    </script>
</body>
</html>
